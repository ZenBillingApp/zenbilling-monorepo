name: CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:
        inputs:
            force_deploy_all:
                description: "Force deployment of all services"
                required: false
                default: "false"
                type: choice
                options:
                    - "true"
                    - "false"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            services: ${{ steps.changes.outputs.services }}
            shared-changed: ${{ steps.changes.outputs.shared-changed }}
            force-all: ${{ steps.force-check.outputs.force-all }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check force deployment
              id: force-check
              run: |
                  if [[ "${{ github.event.inputs.force_deploy_all }}" == "true" ]]; then
                    echo "force-all=true" >> $GITHUB_OUTPUT
                  else
                    echo "force-all=false" >> $GITHUB_OUTPUT
                  fi

            - name: Detect changed services
              id: changes
              run: |
                  # Liste de tous les services
                  ALL_SERVICES="api_gateway auth_service stripe_service dashboard_service invoice_service quote_service email_service product_service customer_service pdf_service ai_service"

                  if [[ "${{ steps.force-check.outputs.force-all }}" == "true" ]]; then
                    echo "Force deployment requested - deploying all services"
                    CHANGED_SERVICES="$ALL_SERVICES"
                    SHARED_CHANGED="true"
                  elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    # For manual dispatch without force, still check for changes
                    if git diff --name-only HEAD~1 | grep -q "^packages/shared/"; then
                      echo "Shared package changed - deploying all services"
                      CHANGED_SERVICES="$ALL_SERVICES"
                      SHARED_CHANGED="true"
                    else
                      CHANGED_SERVICES=""
                      for service in $ALL_SERVICES; do
                        if git diff --name-only HEAD~1 | grep -q "^packages/$service/"; then
                          CHANGED_SERVICES="$CHANGED_SERVICES $service"
                        fi
                      done
                      SHARED_CHANGED="false"
                    fi
                  else
                    # For push/PR events, compare with base
                    BASE_SHA="${{ github.event.before }}"
                    if [[ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
                      # First push to branch, compare with main
                      BASE_SHA="origin/main"
                    fi

                    if git diff --name-only $BASE_SHA...HEAD | grep -q "^packages/shared/"; then
                      echo "Shared package changed - deploying all services"
                      CHANGED_SERVICES="$ALL_SERVICES"
                      SHARED_CHANGED="true"
                    else
                      CHANGED_SERVICES=""
                      for service in $ALL_SERVICES; do
                        if git diff --name-only $BASE_SHA...HEAD | grep -q "^packages/$service/"; then
                          CHANGED_SERVICES="$CHANGED_SERVICES $service"
                        fi
                      done
                      SHARED_CHANGED="false"
                    fi
                  fi

                  # Convert to JSON array
                  if [[ -n "$CHANGED_SERVICES" ]]; then
                    SERVICES_JSON=$(echo "$CHANGED_SERVICES" | tr ' ' '\n' | grep -v '^$' | jq -R . | jq -s -c .)
                  else
                    SERVICES_JSON="[]"
                  fi

                  echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
                  echo "shared-changed=$SHARED_CHANGED" >> $GITHUB_OUTPUT

                  echo "Changed services: $CHANGED_SERVICES"
                  echo "Services JSON: $SERVICES_JSON"

    type-check:
        runs-on: ubuntu-latest
        needs: detect-changes
        if: needs.detect-changes.outputs.shared-changed == 'true' || fromJSON(needs.detect-changes.outputs.services)[0] != null
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Generate Prisma Client
              run: |
                  cd packages/shared
                  npm run prisma:generate

            - name: Type Check Shared
              run: |
                  cd packages/shared
                  npm run build

            - name: Type Check Services
              if: needs.detect-changes.outputs.shared-changed != 'true'
              run: |
                  services='${{ needs.detect-changes.outputs.services }}'
                  echo $services | jq -r '.[]' | while read service; do
                      echo "Checking $service..."
                      cd packages/$service
                      if [ -f "tsconfig.json" ]; then
                          npm run build
                      fi
                      cd ../..
                  done

    build-shared:
        runs-on: ubuntu-latest
        needs: [detect-changes, type-check]
        if: needs.detect-changes.outputs.shared-changed == 'true' || fromJSON(needs.detect-changes.outputs.services)[0] != null
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build shared package
              run: |
                  cd packages/shared
                  npm run prisma:generate
                  npm run build

            - name: Cache shared build
              uses: actions/cache@v3
              with:
                  path: |
                      packages/shared/dist
                      packages/shared/node_modules/.prisma
                  key: shared-build-${{ github.sha }}

    build-and-push:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-shared]
        if: fromJSON(needs.detect-changes.outputs.services)[0] != null
        strategy:
            matrix:
                service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
        steps:
            - uses: actions/checkout@v4

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              if: github.event_name != 'pull_request'
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Restore shared build cache
              uses: actions/cache@v3
              with:
                  path: |
                      packages/shared/dist
                      packages/shared/node_modules/.prisma
                  key: shared-build-${{ github.sha }}

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ secrets.DOCKER_USERNAME }}/zenbilling-${{ matrix.service }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=sha,prefix={{branch}}-
                      type=raw,value=latest,enable={{is_default_branch}}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./packages/${{ matrix.service }}/Dockerfile
                  platforms: linux/amd64
                  push: ${{ github.event_name != 'pull_request' }}
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Run Trivy vulnerability scanner
              if: github.event_name != 'pull_request'
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ secrets.DOCKER_USERNAME }}/zenbilling-${{ matrix.service }}:${{ github.ref_name }}-${{ github.sha }}
                  format: "sarif"
                  output: "trivy-results-${{ matrix.service }}.sarif"
              env:
                  TRIVY_USERNAME: ${{ secrets.DOCKER_USERNAME }}
                  TRIVY_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
              continue-on-error: true

            - name: Check Trivy results
              id: check-trivy
              if: github.event_name != 'pull_request'
              run: |
                  if [[ -f "trivy-results-${{ matrix.service }}.sarif" && -s "trivy-results-${{ matrix.service }}.sarif" ]]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Upload Trivy scan results to GitHub Security tab
              if: github.event_name != 'pull_request' && steps.check-trivy.outputs.exists == 'true'
              uses: github/codeql-action/upload-sarif@v4
              with:
                  sarif_file: "trivy-results-${{ matrix.service }}.sarif"

    trigger-coolify-deployment:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-and-push]
        if: github.event_name != 'pull_request' && fromJSON(needs.detect-changes.outputs.services)[0] != null
        strategy:
            matrix:
                service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
        steps:
            - name: Determine environment
              id: env
              run: |
                  if [[ "${{ github.ref_name }}" == "main" ]]; then
                    echo "environment=PROD" >> $GITHUB_OUTPUT
                    echo "env_name=Production" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.ref_name }}" == "develop" ]]; then
                    echo "environment=DEV" >> $GITHUB_OUTPUT
                    echo "env_name=Development" >> $GITHUB_OUTPUT
                  else
                    echo "environment=DEV" >> $GITHUB_OUTPUT
                    echo "env_name=Development" >> $GITHUB_OUTPUT
                  fi

            - name: Trigger Coolify Deployment for ${{ matrix.service }} (${{ steps.env.outputs.env_name }})
              run: |
                  # Coolify webhook endpoint pour chaque service selon l'environnement
                  SERVICE_UPPER=$(echo ${{ matrix.service }} | tr '[:lower:]' '[:upper:]')
                  WEBHOOK_SECRET_NAME="COOLIFY_WEBHOOK_${SERVICE_UPPER}_${{ steps.env.outputs.environment }}"
                  TOKEN_SECRET_NAME="COOLIFY_API_TOKEN_${{ steps.env.outputs.environment }}"

                  WEBHOOK_URL="${!WEBHOOK_SECRET_NAME}"
                  API_TOKEN="${!TOKEN_SECRET_NAME}"

                  echo "ðŸ” Looking for webhook: ${WEBHOOK_SECRET_NAME}"
                  echo "ðŸ” Looking for token: ${TOKEN_SECRET_NAME}"

                  if [[ -n "$WEBHOOK_URL" && -n "$API_TOKEN" ]]; then
                    echo "ðŸš€ Triggering Coolify deployment for ${{ matrix.service }} in ${{ steps.env.outputs.env_name }}..."

                    # DÃ©clencher le dÃ©ploiement via GET request
                    response=$(curl -w "%{http_code}" -s -o /dev/null \
                      --request GET \
                      --header "Authorization: Bearer $API_TOKEN" \
                      "$WEBHOOK_URL")

                    if [[ "$response" -eq 200 ]]; then
                      echo "âœ… Successfully triggered deployment for ${{ matrix.service }} in ${{ steps.env.outputs.env_name }}"
                    else
                      echo "âŒ Failed to trigger deployment for ${{ matrix.service }} in ${{ steps.env.outputs.env_name }} (HTTP: $response)"
                      exit 1
                    fi
                  else
                    echo "âš ï¸  Missing Coolify configuration for ${{ matrix.service }} in ${{ steps.env.outputs.env_name }}"
                    if [[ -z "$WEBHOOK_URL" ]]; then
                      echo "   Missing secret: ${WEBHOOK_SECRET_NAME}"
                    fi
                    if [[ -z "$API_TOKEN" ]]; then
                      echo "   Missing secret: ${TOKEN_SECRET_NAME}"
                    fi
                    echo "Please add these secrets in GitHub repository settings"
                  fi
              env:
                  # Production environment webhooks
                  COOLIFY_WEBHOOK_API_GATEWAY_PROD: ${{ secrets.COOLIFY_WEBHOOK_API_GATEWAY_PROD }}
                  COOLIFY_WEBHOOK_AUTH_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_AUTH_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_COMPANY_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_COMPANY_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_STRIPE_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_STRIPE_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_DASHBOARD_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_DASHBOARD_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_INVOICE_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_INVOICE_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_QUOTE_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_QUOTE_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_EMAIL_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_EMAIL_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_PRODUCT_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_PRODUCT_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_CUSTOMER_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_CUSTOMER_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_PDF_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_PDF_SERVICE_PROD }}
                  COOLIFY_WEBHOOK_AI_SERVICE_PROD: ${{ secrets.COOLIFY_WEBHOOK_AI_SERVICE_PROD }}

                  # Development environment webhooks
                  COOLIFY_WEBHOOK_API_GATEWAY_DEV: ${{ secrets.COOLIFY_WEBHOOK_API_GATEWAY_DEV }}
                  COOLIFY_WEBHOOK_AUTH_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_AUTH_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_STRIPE_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_STRIPE_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_DASHBOARD_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_DASHBOARD_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_INVOICE_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_INVOICE_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_QUOTE_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_QUOTE_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_EMAIL_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_EMAIL_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_PRODUCT_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_PRODUCT_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_CUSTOMER_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_CUSTOMER_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_PDF_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_PDF_SERVICE_DEV }}
                  COOLIFY_WEBHOOK_AI_SERVICE_DEV: ${{ secrets.COOLIFY_WEBHOOK_AI_SERVICE_DEV }}

                  # API Tokens per environment
                  COOLIFY_API_TOKEN_PROD: ${{ secrets.COOLIFY_API_TOKEN_PROD }}
                  COOLIFY_API_TOKEN_DEV: ${{ secrets.COOLIFY_API_TOKEN_DEV }}

    deploy-summary:
        runs-on: ubuntu-latest
        needs: [detect-changes, build-and-push, trigger-coolify-deployment]
        if: always()
        steps:
            - name: Deployment Summary
              run: |
                  echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ needs.detect-changes.outputs.force-all }}" == "true" ]]; then
                    echo "âœ… **Force deployment**: All services deployed" >> $GITHUB_STEP_SUMMARY
                  elif [[ "${{ needs.detect-changes.outputs.shared-changed }}" == "true" ]]; then
                    echo "âœ… **Shared package changed**: All services rebuilt and deployed" >> $GITHUB_STEP_SUMMARY
                  else
                    services="${{ needs.detect-changes.outputs.services }}"
                    if [[ "$services" != "[]" ]]; then
                      echo "âœ… **Services deployed**: $(echo '${{ needs.detect-changes.outputs.services }}' | jq -r '.[]' | tr '\n' ' ')" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "â„¹ï¸ **No changes detected**: No services deployed" >> $GITHUB_STEP_SUMMARY
                    fi
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“¦ **Docker Images**: Available on Docker Hub with tags:" >> $GITHUB_STEP_SUMMARY
                  echo "- \`latest\` (main branch)" >> $GITHUB_STEP_SUMMARY
                  echo "- \`develop\` (develop branch)" >> $GITHUB_STEP_SUMMARY
                  echo "- \`${{ github.ref_name }}-${{ github.sha }}\` (this build)" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ–¥ï¸ **Platform**: linux/amd64 (optimized for Coolify self-hosted)" >> $GITHUB_STEP_SUMMARY

                  if [[ "${{ github.event_name }}" != "pull_request" ]]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    if [[ "${{ github.ref_name }}" == "main" ]]; then
                      echo "ðŸ”„ **Coolify Deployments**: Triggered automatically in **Production** for changed services" >> $GITHUB_STEP_SUMMARY
                    elif [[ "${{ github.ref_name }}" == "develop" ]]; then
                      echo "ðŸ”„ **Coolify Deployments**: Triggered automatically in **Development** for changed services" >> $GITHUB_STEP_SUMMARY
                    else
                      echo "ðŸ”„ **Coolify Deployments**: Triggered automatically in **Development** for changed services" >> $GITHUB_STEP_SUMMARY
                    fi
                  fi
