# =============================================================
# ZenBilling - Docker Compose Production
# =============================================================
# Prerequis : PostgreSQL externe accessible via DATABASE_URL
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose logs -f auth_service     # Follow logs
#   docker compose down                     # Stop all
# =============================================================

services:
    # ===========================================================
    # PRISMA MIGRATIONS (run once against external DB, then exit)
    # ===========================================================

    prisma-migrate:
        build:
            context: .
            dockerfile: Dockerfile.migrate
        container_name: zenbilling-migrate
        environment:
            DATABASE_URL: ${DATABASE_URL}
        networks:
            - zenbilling-net
        restart: "no"

    # ===========================================================
    # API GATEWAY
    # ===========================================================

    api_gateway:
        build:
            context: .
            dockerfile: packages/api_gateway/Dockerfile
        container_name: zenbilling-gateway
        restart: always
        ports:
            - "${PORT_API_GATEWAY:-8100}:8080"
        environment:
            PORT: 8080
            NODE_ENV: production
            AUTH_SERVICE_URL: http://auth_service:3001
            COMPANY_SERVICE_URL: http://company_service:3002
            STRIPE_SERVICE_URL: http://stripe_service:3003
            DASHBOARD_SERVICE_URL: http://dashboard_service:3004
            INVOICE_SERVICE_URL: http://invoice_service:3005
            QUOTE_SERVICE_URL: http://quote_service:3006
            PRODUCT_SERVICE_URL: http://product_service:3008
            CUSTOMER_SERVICE_URL: http://customer_service:3009
            AI_SERVICE_URL: http://ai_service:3011
        depends_on:
            auth_service:
                condition: service_healthy
        networks:
            - zenbilling-net

    # ===========================================================
    # BACKEND SERVICES
    # ===========================================================

    auth_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: auth_service
                SERVICE_PORT: "3001"
        container_name: zenbilling-auth
        restart: always
        environment:
            PORT: 3001
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
            BETTER_AUTH_URL: ${BETTER_AUTH_URL}
            CLIENT_URL: ${CLIENT_URL}
            API_GATEWAY_URL: ${API_GATEWAY_URL}
            COOKIE_DOMAIN: ${COOKIE_DOMAIN}
            GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    company_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: company_service
                SERVICE_PORT: "3002"
        container_name: zenbilling-company
        restart: always
        environment:
            PORT: 3002
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    stripe_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: stripe_service
                SERVICE_PORT: "3003"
        container_name: zenbilling-stripe
        restart: always
        environment:
            PORT: 3003
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
            STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    dashboard_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: dashboard_service
                SERVICE_PORT: "3004"
        container_name: zenbilling-dashboard
        restart: always
        environment:
            PORT: 3004
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    invoice_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: invoice_service
                SERVICE_PORT: "3005"
        container_name: zenbilling-invoice
        restart: always
        environment:
            PORT: 3005
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
            PDF_SERVICE_URL: http://pdf_service:3010
            EMAIL_SERVICE_URL: http://email_service:3007
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    quote_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: quote_service
                SERVICE_PORT: "3006"
        container_name: zenbilling-quote
        restart: always
        environment:
            PORT: 3006
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
            PDF_SERVICE_URL: http://pdf_service:3010
            EMAIL_SERVICE_URL: http://email_service:3007
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    email_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: email_service
                SERVICE_PORT: "3007"
        container_name: zenbilling-email
        restart: always
        environment:
            PORT: 3007
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            BREVO_API_KEY: ${BREVO_API_KEY}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    product_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: product_service
                SERVICE_PORT: "3008"
        container_name: zenbilling-product
        restart: always
        environment:
            PORT: 3008
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
            AI_SERVICE_URL: http://ai_service:3011
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    customer_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: customer_service
                SERVICE_PORT: "3009"
        container_name: zenbilling-customer
        restart: always
        environment:
            PORT: 3009
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    pdf_service:
        build:
            context: .
            dockerfile: packages/pdf_service/Dockerfile
        container_name: zenbilling-pdf
        restart: always
        environment:
            PORT: 3010
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

    ai_service:
        build:
            context: .
            dockerfile: Dockerfile.service
            args:
                SERVICE_NAME: ai_service
                SERVICE_PORT: "3011"
        container_name: zenbilling-ai
        restart: always
        environment:
            PORT: 3011
            NODE_ENV: production
            DATABASE_URL: ${DATABASE_URL}
            OPENAI_API_KEY: ${OPENAI_API_KEY}
            OPENAI_MODEL: ${OPENAI_MODEL:-gpt-3.5-turbo}
            OPENAI_MAX_TOKENS: ${OPENAI_MAX_TOKENS:-500}
            OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE:-0.7}
            INTERNAL_SHARED_SECRET: ${INTERNAL_SHARED_SECRET}
            AUTH_SERVICE_URL: http://auth_service:3001
        depends_on:
            prisma-migrate:
                condition: service_completed_successfully
        networks:
            - zenbilling-net

# ===========================================================
# NETWORKS
# ===========================================================
networks:
    zenbilling-net:
        driver: bridge
